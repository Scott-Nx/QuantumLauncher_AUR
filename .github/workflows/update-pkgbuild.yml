name: Update PKGBUILD

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: "0 0 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  check-update:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base
    permissions:
      contents: write

    steps:
      - name: Prepare pacman environment
        run: |
          pacman -Sy --noconfirm archlinux-keyring
          pacman-key --init
          pacman-key --populate
          pacman -Syu --noconfirm base-devel git jq wget curl

      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Check for new release
        id: check_release
        run: |
          # Get latest release from GitHub API
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/Mrmayman/quantumlauncher/releases/latest | jq -r '.tag_name')
          LATEST_VERSION=${LATEST_RELEASE#v}

          # Get current version from PKGBUILD
          CURRENT_VERSION=$(grep -oP '^pkgver=\K.*' PKGBUILD)

          echo "Latest version: $LATEST_VERSION"
          echo "Current version: $CURRENT_VERSION"

          # Set outputs
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest_release=$LATEST_RELEASE" >> $GITHUB_OUTPUT

          if [ "$LATEST_VERSION" != "$CURRENT_VERSION" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "New version available: $LATEST_VERSION"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Already up to date"
          fi

      - name: Download and calculate checksums
        if: steps.check_release.outputs.needs_update == 'true'
        id: checksum
        run: |
          # Download all architecture releases
          wget "https://github.com/Mrmayman/quantumlauncher/releases/download/${{ steps.check_release.outputs.latest_release }}/quantum_launcher_linux_x86_64.zip"
          wget "https://github.com/Mrmayman/quantumlauncher/releases/download/${{ steps.check_release.outputs.latest_release }}/quantum_launcher_linux_aarch64.zip"
          wget "https://github.com/Mrmayman/quantumlauncher/releases/download/${{ steps.check_release.outputs.latest_release }}/quantum_launcher_linux_arm32.zip"

          # Calculate SHA256 for each architecture
          SHA256_X86_64=$(sha256sum quantum_launcher_linux_x86_64.zip | awk '{print $1}')
          SHA256_AARCH64=$(sha256sum quantum_launcher_linux_aarch64.zip | awk '{print $1}')
          SHA256_ARMV7H=$(sha256sum quantum_launcher_linux_arm32.zip | awk '{print $1}')

          echo "sha256_x86_64=$SHA256_X86_64" >> $GITHUB_OUTPUT
          echo "sha256_aarch64=$SHA256_AARCH64" >> $GITHUB_OUTPUT
          echo "sha256_armv7h=$SHA256_ARMV7H" >> $GITHUB_OUTPUT

          echo "SHA256 x86_64: $SHA256_X86_64"
          echo "SHA256 aarch64: $SHA256_AARCH64"
          echo "SHA256 armv7h: $SHA256_ARMV7H"

      - name: Update PKGBUILD
        if: steps.check_release.outputs.needs_update == 'true'
        run: |
          # Update version
          sed -i "s/^pkgver=.*/pkgver=${{ steps.check_release.outputs.latest_version }}/" PKGBUILD

          # Reset pkgrel to 1
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD

          # Update checksums for all architectures
          sed -i "s/^sha256sums_x86_64=.*/sha256sums_x86_64=('${{ steps.checksum.outputs.sha256_x86_64 }}')/" PKGBUILD
          sed -i "s/^sha256sums_aarch64=.*/sha256sums_aarch64=('${{ steps.checksum.outputs.sha256_aarch64 }}')/" PKGBUILD
          sed -i "s/^sha256sums_armv7h=.*/sha256sums_armv7h=('${{ steps.checksum.outputs.sha256_armv7h }}')/" PKGBUILD

          echo "PKGBUILD updated successfully"

      - name: Generate .SRCINFO
        if: steps.check_release.outputs.needs_update == 'true'
        run: |
          id builder &>/dev/null || useradd -m builder
          chown -R builder:builder "$GITHUB_WORKSPACE"
          runuser -u builder -- makepkg --printsrcinfo > .SRCINFO
          echo ".SRCINFO updated successfully"

      - name: Commit and push changes
        if: steps.check_release.outputs.needs_update == 'true'
        run: |
          # Mark the directory as safe for git operations
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --local user.email "158021536+Scott-Nx@users.noreply.github.com"
          git config --local user.name "Scott-Nx"

          git add PKGBUILD .SRCINFO
          git commit -m "build(release): bump version to ${{ steps.check_release.outputs.latest_version }}"
          git push
